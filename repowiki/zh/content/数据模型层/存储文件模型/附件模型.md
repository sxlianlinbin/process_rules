# 附件模型

<cite>
**本文引用的文件**
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php)
- [AttachmentAuthModel.php](file://process/src/models/AttachmentAuthModel.php)
- [File.php](file://process/src/http/api/File.php)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php)
- [Local.php](file://process/src/services/storage/Local.php)
- [IFileStorage.php](file://process/src/services/storage/IFileStorage.php)
- [ImageHelper.php](file://process/src/helpers/ImageHelper.php)
- [upload.php](file://process/src/config/upload.php)
- [migration_20241130_193521_attachment_auth.php](file://process/src/migrations/migration_20241130_193521_attachment_auth.php)
- [migration_20250714_234817_ai_intelligent_agents_nzsc.php](file://process/src/migrations/migration_20250714_234817_ai_intelligent_agents_nzsc.php)
- [Excel.php](file://process/src/services/excel/Excel.php)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本文件系统性梳理附件模型的设计理念与实现细节，围绕以下主题展开：
- 文件元数据管理：文件名、大小、类型、扩展名、宽高、会话关联等
- 存储路径生成算法与目录结构组织
- 文件ID生成机制与下载token安全机制
- 文件上传流程：单文件、分片上传、合并、保存策略
- 访问控制：受保护文件的权限管理、下载token验证、会话关联
- 缩略图生成、图片尺寸处理与内容存储
- 文件导入导出、Excel解析与远程文件处理

## 项目结构
围绕附件模型的关键文件分布如下：
- 模型层：AttachmentModel（附件核心模型）、AttachmentAuthModel（附件权限表）
- 控制器层：File（上传、分片、合并、下载响应）
- 存储抽象：IFileStorage 接口、Local 实现（本地存储）、StorageHelper 工具
- 辅助工具：ImageHelper（图片处理）、Excel（Excel解析）
- 配置：upload.php（扩展名白名单）
- 迁移：attachment_auth 表结构、AI智能体导入迁移中对附件的使用

```mermaid
graph TB
subgraph "模型层"
AM["AttachmentModel<br/>附件核心模型"]
AAM["AttachmentAuthModel<br/>附件权限表"]
end
subgraph "控制器层"
FC["File<br/>上传/分片/合并/下载"]
end
subgraph "存储抽象"
IF["IFileStorage<br/>接口"]
LS["Local<br/>本地存储实现"]
SH["StorageHelper<br/>存储客户端工厂"]
end
subgraph "辅助工具"
IH["ImageHelper<br/>图片处理"]
EX["Excel<br/>Excel解析"]
end
subgraph "配置"
UCFG["upload.php<br/>扩展名白名单"]
end
FC --> AM
FC --> SH
SH --> LS
LS --> IF
AM --> IH
AM --> EX
AM --> AAM
FC --> UCFG
```

图表来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L1-L253)
- [AttachmentAuthModel.php](file://process/src/models/AttachmentAuthModel.php#L1-L22)
- [File.php](file://process/src/http/api/File.php#L1-L200)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)
- [Local.php](file://process/src/services/storage/Local.php#L1-L143)
- [IFileStorage.php](file://process/src/services/storage/IFileStorage.php#L1-L54)
- [ImageHelper.php](file://process/src/helpers/ImageHelper.php#L104-L156)
- [Excel.php](file://process/src/services/excel/Excel.php#L1-L200)
- [upload.php](file://process/src/config/upload.php#L1-L15)

章节来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L1-L253)
- [File.php](file://process/src/http/api/File.php#L1-L200)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)
- [Local.php](file://process/src/services/storage/Local.php#L1-L143)
- [IFileStorage.php](file://process/src/services/storage/IFileStorage.php#L1-L54)
- [ImageHelper.php](file://process/src/helpers/ImageHelper.php#L104-L156)
- [Excel.php](file://process/src/services/excel/Excel.php#L1-L200)
- [upload.php](file://process/src/config/upload.php#L1-L15)

## 核心组件
- AttachmentModel：负责附件元数据、ID与token生成、分片路径解析、文件保存策略、缩略图生成、Excel导入、远程URL转存等
- AttachmentAuthModel：记录附件与用户之间的授权关系
- File 控制器：对外提供上传、分片、合并接口，并调用模型完成入库与存储
- StorageHelper：统一获取存储客户端（默认本地存储）
- Local：实现 IFileStorage，负责文件落盘、目录组织、缩略图生成、PDF转换、流式读写等
- ImageHelper：图片打开、旋转、自适应缩放、水印等
- Excel：Excel 导入生成器（迭代器）

章节来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L1-L253)
- [AttachmentAuthModel.php](file://process/src/models/AttachmentAuthModel.php#L1-L22)
- [File.php](file://process/src/http/api/File.php#L1-L200)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)
- [Local.php](file://process/src/services/storage/Local.php#L1-L143)
- [IFileStorage.php](file://process/src/services/storage/IFileStorage.php#L1-L54)
- [ImageHelper.php](file://process/src/helpers/ImageHelper.php#L104-L156)
- [Excel.php](file://process/src/services/excel/Excel.php#L1-L200)

## 架构总览
附件系统采用“模型-控制器-存储”三层协作：
- 控制器接收请求，校验参数与扩展名，执行图片压缩与安全检测
- 模型生成ID与token，决定保存路径与目录结构
- 存储层负责实际落盘、缩略图生成、PDF转换、流式读写

```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "File 控制器"
participant Model as "AttachmentModel"
participant Store as "StorageHelper/Local"
Client->>API : "上传/分片/合并 请求"
API->>API : "校验文件类型与大小"
API->>Model : "createId() 生成ID与token"
API->>Store : "put()/putMultipart() 保存文件"
Store-->>API : "返回存储相对路径"
API->>Model : "save() 元数据入库"
API-->>Client : "返回token/文件名/状态"
```

图表来源
- [File.php](file://process/src/http/api/File.php#L43-L121)
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L73-L124)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)
- [Local.php](file://process/src/services/storage/Local.php#L25-L43)

## 详细组件分析

### AttachmentModel 类设计与实现
- 元数据字段：id、name、file、size、width、height、sess_id、mime、ext、created、deadline、type、download、protected、creator、token、sess_ids、aigc_file_id
- 权限常量：无保护、用户级保护、系统级保护
- ID与token生成：通过序列号生成id，并生成固定长度随机token；下载token由token+id拼接
- 下载token解析：按固定长度拆分token与id，校验一致性
- 会话关联：支持将当前会话加入sess_ids，设置deadline与主会话id
- 分片路径解析：按“日期前缀+随机片段”的规则解析临时分片路径
- 分片保存：按日期子目录生成随机文件名，移动上传文件到目标位置
- 文件保存策略：按id/2000进行两级目录组织，文件名为id.ext
- 缩略图生成：若请求宽高有效则生成宽×高命名的缩略图，否则返回原图路径
- Excel导入：通过存储层获取真实路径，委托Excel模块进行迭代导入
- URL转存：从远程URL抓取内容，生成临时文件并写入存储，返回模型对象
- 保存前置逻辑：去重合并sess_ids，保证主会话id存在时更新

```mermaid
classDiagram
class AttachmentModel {
+const PROTECTED_NONE
+const PROTECTED_USER
+const PROTECTED_SYSTEM
+createId() void
+getDownloadToken() string
+getByToken(token) AttachmentModel?
+updateSession(token, sessId, deadline) void
+getPiece(key) string
+savePiece(filePath) string
+saveFile(category, src, isContent=false) void
+getThumb(width, height) string
+readExcel(token, sheet=0, row=2) Generator
+getTokenId(token) string
+saveSimpleFile(url) AttachmentModel?
+beforeSave() void
}
class AttachmentAuthModel {
+file_id : int
+uid : int
+created : timestamp
}
AttachmentModel --> AttachmentAuthModel : "受保护文件权限关联"
```

图表来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L66-L253)
- [AttachmentAuthModel.php](file://process/src/models/AttachmentAuthModel.php#L1-L22)

章节来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L66-L253)
- [AttachmentAuthModel.php](file://process/src/models/AttachmentAuthModel.php#L1-L22)

### 文件上传流程（单文件/分片/合并）
- 单文件上传：控制器校验扩展名与大小，必要时对图片进行压缩，随后创建模型、生成ID与token，调用存储客户端保存，最后入库
- 分片上传：仅分配ID与token，将分片保存到存储，返回分片key
- 合并流程：按序读取各分片内容写入临时文件，调用模型保存方法写入最终存储，返回文件名与token

```mermaid
sequenceDiagram
participant C as "客户端"
participant F as "File 控制器"
participant M as "AttachmentModel"
participant S as "StorageHelper/Local"
C->>F : "upPiece() 上传分片"
F->>M : "createId()"
F->>S : "put(token+id, 分片)"
S-->>F : "返回key"
F-->>C : "Success({key})"
C->>F : "merge(keys, file_name)"
F->>S : "getContent(key) 顺序读取"
F->>M : "createModel(...)"
F->>S : "putMultipart(token, 合并文件)"
S-->>F : "返回存储路径"
F->>M : "save()"
F-->>C : "Success({name, token})"
```

图表来源
- [File.php](file://process/src/http/api/File.php#L43-L121)
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L125-L179)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)
- [Local.php](file://process/src/services/storage/Local.php#L40-L43)

章节来源
- [File.php](file://process/src/http/api/File.php#L43-L121)
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L125-L179)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)
- [Local.php](file://process/src/services/storage/Local.php#L40-L43)

### 存储路径生成与目录结构
- 本地存储相对目录：按年月组织，例如“process50/Ym”
- 物理绝对路径：uploadDir + 相对目录
- 附件文件目录：category/id_per_2000，文件名为id.ext
- 分片临时目录：uploadDir/日期，文件名为随机十六进制字符串
- 缩略图目录：与原图同目录，文件名为id_w_h.ext

```mermaid
flowchart TD
Start(["开始"]) --> GenCat["确定分类与id_per_2000"]
GenCat --> BuildPath["拼接相对路径<br/>category/id_per_2000"]
BuildPath --> EnsureDir{"目录存在？"}
EnsureDir --> |否| MkDir["mkdir -p 创建目录"]
EnsureDir --> |是| SaveFile["写入文件 id.ext"]
MkDir --> SaveFile
SaveFile --> Done(["结束"])
```

图表来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L155-L179)
- [Local.php](file://process/src/services/storage/Local.php#L25-L38)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)

章节来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L155-L179)
- [Local.php](file://process/src/services/storage/Local.php#L25-L38)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)

### 文件ID与下载token安全机制
- ID生成：使用数据库序列号生成唯一递增id
- token生成：固定长度随机字节，保证不可预测性
- 下载token：token + id 的拼接形式
- 解析与校验：按固定长度拆分token与id，查询对应记录并比对token一致性
- 会话绑定：将当前会话id写入sess_ids，支持deadline设置

```mermaid
flowchart TD
A["生成ID与Token"] --> B["保存分片/合并文件"]
B --> C["入库：记录name/size/ext/token等"]
C --> D["下载请求：token"]
D --> E["拆分token与id"]
E --> F{"记录存在且token一致？"}
F --> |是| G["允许访问/返回文件"]
F --> |否| H["拒绝访问/报错"]
```

图表来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L73-L124)

章节来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L73-L124)

### 文件访问控制与权限管理
- 受保护文件：支持三种保护级别，登录态下才可上传受保护文件
- 附件权限表：attachment_auth 记录file_id与uid的授权关系
- 会话关联：updateSession 支持将当前会话id写入附件，便于后续审计与访问控制
- 下载token：作为一次性访问凭证，结合模型校验与会话信息共同保障安全

```mermaid
sequenceDiagram
participant U as "用户"
participant F as "File 控制器"
participant M as "AttachmentModel"
participant A as "AttachmentAuthModel"
U->>F : "上传受保护文件"
F->>M : "createId(), set protected"
F->>M : "save() 入库"
U->>F : "申请下载"
F->>M : "getByToken(token)"
M-->>F : "校验通过/失败"
F->>A : "检查授权(可选)"
A-->>F : "授权结果"
F-->>U : "返回文件/拒绝"
```

图表来源
- [File.php](file://process/src/http/api/File.php#L131-L200)
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L84-L124)
- [AttachmentAuthModel.php](file://process/src/models/AttachmentAuthModel.php#L1-L22)
- [migration_20241130_193521_attachment_auth.php](file://process/src/migrations/migration_20241130_193521_attachment_auth.php#L1-L26)

章节来源
- [File.php](file://process/src/http/api/File.php#L131-L200)
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L84-L124)
- [AttachmentAuthModel.php](file://process/src/models/AttachmentAuthModel.php#L1-L22)
- [migration_20241130_193521_attachment_auth.php](file://process/src/migrations/migration_20241130_193521_attachment_auth.php#L1-L26)

### 缩略图生成、图片尺寸处理与内容存储
- 缩略图生成：在原图同目录生成 id_w_h.ext，若已存在则直接复用
- 图片处理：ImageHelper 提供打开、自适应缩放、旋转、水印等能力
- 内容存储：支持将字符串内容写入存储，用于URL转存等场景
- PDF转换：本地存储实现提供PDF转换入口，返回PDF响应

```mermaid
flowchart TD
S(["请求缩略图"]) --> Check["检查缓存/文件是否存在"]
Check --> |存在| Return["直接返回缩略图路径"]
Check --> |不存在| Open["ImageHelper 打开原图"]
Open --> Resize["自适应缩放到指定宽高"]
Resize --> Save["保存为缩略图文件"]
Save --> Return
```

图表来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L184-L199)
- [ImageHelper.php](file://process/src/helpers/ImageHelper.php#L104-L156)
- [Local.php](file://process/src/services/storage/Local.php#L74-L101)

章节来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L184-L199)
- [ImageHelper.php](file://process/src/helpers/ImageHelper.php#L104-L156)
- [Local.php](file://process/src/services/storage/Local.php#L74-L101)

### 文件导入导出、Excel解析与远程文件处理
- Excel导入：通过模型的readExcel方法，基于存储层的真实路径，委托Excel模块进行迭代导入
- 远程文件处理：saveSimpleFile从URL抓取内容，生成临时文件并写入存储，返回模型对象
- AI集成：迁移脚本中展示如何创建附件并写入存储，体现与AI助手的集成点

```mermaid
sequenceDiagram
participant C as "客户端"
participant M as "AttachmentModel"
participant S as "StorageHelper/Local"
participant E as "Excel"
C->>M : "readExcel(token, sheet, row)"
M->>S : "getContentFilePath(文件路径)"
S-->>M : "返回真实路径"
M->>E : "importGen(路径, sheet, row)"
E-->>M : "迭代返回行数据"
M-->>C : "逐行消费数据"
```

图表来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L206-L211)
- [Excel.php](file://process/src/services/excel/Excel.php#L1-L200)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)
- [Local.php](file://process/src/services/storage/Local.php#L122-L131)

章节来源
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L206-L211)
- [Excel.php](file://process/src/services/excel/Excel.php#L1-L200)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)
- [Local.php](file://process/src/services/storage/Local.php#L122-L131)
- [migration_20250714_234817_ai_intelligent_agents_nzsc.php](file://process/src/migrations/migration_20250714_234817_ai_intelligent_agents_nzsc.php#L46-L66)

## 依赖关系分析
- 控制器依赖模型与存储助手
- 模型依赖存储助手与Excel模块
- 存储实现依赖本地文件系统与图片处理工具
- 权限模型独立存在，与附件模型通过外键关联

```mermaid
graph LR
FileCtrl["File 控制器"] --> AM["AttachmentModel"]
FileCtrl --> SH["StorageHelper"]
AM --> SH
AM --> EX["Excel"]
SH --> LS["Local"]
LS --> IH["ImageHelper"]
AM --> AAM["AttachmentAuthModel"]
```

图表来源
- [File.php](file://process/src/http/api/File.php#L1-L200)
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L1-L253)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)
- [Local.php](file://process/src/services/storage/Local.php#L1-L143)
- [ImageHelper.php](file://process/src/helpers/ImageHelper.php#L104-L156)
- [Excel.php](file://process/src/services/excel/Excel.php#L1-L200)
- [AttachmentAuthModel.php](file://process/src/models/AttachmentAuthModel.php#L1-L22)

章节来源
- [File.php](file://process/src/http/api/File.php#L1-L200)
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L1-L253)
- [StorageHelper.php](file://process/src/helpers/StorageHelper.php#L1-L48)
- [Local.php](file://process/src/services/storage/Local.php#L1-L143)
- [ImageHelper.php](file://process/src/helpers/ImageHelper.php#L104-L156)
- [Excel.php](file://process/src/services/excel/Excel.php#L1-L200)
- [AttachmentAuthModel.php](file://process/src/models/AttachmentAuthModel.php#L1-L22)

## 性能考量
- 目录层级：按id/2000分桶，降低单目录文件数量，提升文件系统性能
- 缩略图缓存：命中则直接返回，避免重复图像处理
- 流式读写：存储层提供流式读写接口，减少内存占用
- 分片合并：在服务端聚合分片，避免客户端多次IO
- 安全检测：对PDF进行JS风险扫描，降低恶意文件带来的性能与安全风险

## 故障排查指南
- 上传失败：检查存储客户端put/putMultipart返回与chmod权限
- 分片合并异常：确认分片key格式与顺序，核对临时文件清理
- 缩略图未生成：确认目标目录可写与图片格式支持
- 下载token无效：核对token长度、id合法性与记录一致性
- 权限不足：确认attachment_auth授权或受保护文件的登录态

章节来源
- [Local.php](file://process/src/services/storage/Local.php#L25-L43)
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L125-L179)
- [AttachmentModel.php](file://process/src/models/AttachmentModel.php#L84-L124)
- [AttachmentAuthModel.php](file://process/src/models/AttachmentAuthModel.php#L1-L22)

## 结论
AttachmentModel 以清晰的元数据建模、稳健的ID与token安全机制、灵活的存储抽象与完善的访问控制，构建了完整的附件管理体系。配合分片上传、缩略图生成、Excel解析与远程文件处理能力，满足多场景下的文件管理需求。

## 附录
- 扩展名白名单：通过配置文件定义图片、文档、媒体、Excel、Word等类别扩展名集合
- 迁移脚本示例：展示如何在迁移中创建附件并写入存储，体现与AI助手的集成

章节来源
- [upload.php](file://process/src/config/upload.php#L1-L15)
- [migration_20250714_234817_ai_intelligent_agents_nzsc.php](file://process/src/migrations/migration_20250714_234817_ai_intelligent_agents_nzsc.php#L46-L66)